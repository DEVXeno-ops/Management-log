const { SlashCommandBuilder, PermissionFlagsBits, EmbedBuilder } = require('discord.js');

module.exports = {
  data: new SlashCommandBuilder()
    .setName('ban')
    .setDescription('‡πÅ‡∏ö‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå')
    .addUserOption(option =>
      option.setName('target')
        .setDescription('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô')
        .setRequired(true)
    )
    .addStringOption(option =>
      option.setName('reason')
        .setDescription('‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô')
        .setMaxLength(512)
    )
    .setDefaultMemberPermissions(PermissionFlagsBits.BanMembers)
    .setDMPermission(false),

  async execute(interaction) {
    const targetUser = interaction.options.getUser('target');
    const reason = interaction.options.getString('reason') || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•';

    // Fetch member fresh (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ cache) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
    const targetMember = await interaction.guild.members.fetch(targetUser.id).catch(() => null);

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ô‡∏ö‡∏≠‡∏ó
    if (targetUser.id === interaction.user.id) {
      return interaction.reply({ content: '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ö‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ', ephemeral: true });
    }
    if (targetUser.id === interaction.client.user.id) {
      return interaction.reply({ content: '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ö‡∏ô‡∏ö‡∏≠‡∏ó‡πÑ‡∏î‡πâ', ephemeral: true });
    }

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
    if (!targetMember) {
      return interaction.reply({ content: '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', ephemeral: true });
    }

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°
    if (!targetMember.bannable) {
      return interaction.reply({ content: '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ö‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤)', ephemeral: true });
    }

    try {
      // ‡∏™‡πà‡∏á DM ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ô (‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô)
      await targetUser.send({
        embeds: [
          new EmbedBuilder()
            .setColor(0xFF3E3E)
            .setTitle('üö´ ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå')
            .addFields(
              { name: 'üìå ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', value: interaction.guild.name, inline: false },
              { name: 'üìÑ ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', value: reason, inline: false },
              { name: 'üî® ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢', value: interaction.user.tag, inline: false }
            )
            .setTimestamp()
        ]
      }).catch(() => { /* ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á error ‡∏ñ‡πâ‡∏≤ DM ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ */ });

      // ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô
      await targetMember.ban({ reason });

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á Embed ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö log
      const banEmbed = new EmbedBuilder()
        .setTitle('üö´ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå')
        .setColor(0xFF3E3E)
        .setThumbnail(targetUser.displayAvatarURL({ dynamic: true }))
        .addFields(
          { name: 'üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', value: `${targetUser.tag} \`(${targetUser.id})\``, inline: false },
          { name: 'üìÑ ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', value: reason, inline: false },
          { name: 'üî® ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢', value: `${interaction.user.tag} \`(${interaction.user.id})\``, inline: false }
        )
        .setTimestamp();

      // ‡∏™‡πà‡∏á log ‡πÄ‡∏Ç‡πâ‡∏≤ channel ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á mod-logs
      const logChannel = interaction.guild.channels.cache.find(c =>
        ['mod-logs', 'moderation-logs', 'logs'].some(name => c.name.includes(name))
      );
      if (logChannel && logChannel.isTextBased()) {
        logChannel.send({ embeds: [banEmbed] }).catch(console.error);
      }

      // ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡πÅ‡∏ö‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      await interaction.reply({
        embeds: [
          new EmbedBuilder()
            .setColor(0x22BB33)
            .setDescription(`‚úÖ **${targetUser.tag}** ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\nüìÑ ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: \`${reason}\``)
        ],
        ephemeral: true
      });

    } catch (error) {
      console.error('‚ùå Ban Command Error:', error);
      await interaction.reply({
        content: '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ö‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ',
        ephemeral: true
      });
    }
  }
};
